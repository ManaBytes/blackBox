<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Watch History Playlist Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: #1a1a1a;
            color: #f4f4f4;
        }
        body.light-mode {
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
        }
        .dark-mode .container {
            background-color: #2a2a2a;
        }
        .light-mode .container {
            background-color: #fff;
        }
        h1, h2 {
            color: #4CAF50;
        }
        #fileInput, #privacySelect {
            margin-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        #status, #progress, #quotaStatus {
            margin-top: 20px;
            font-weight: bold;
        }
        #progressBar {
            width: 100%;
            background-color: #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }
        #progressBarFill {
            width: 0%;
            height: 30px;
            background-color: #4CAF50;
            border-radius: 5px;
            text-align: center;
            line-height: 30px;
            color: white;
        }
        #modeToggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        pre {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-left: 3px solid #4CAF50;
            color: #333;
            page-break-inside: avoid;
            font-family: monospace;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 1.6em;
            max-width: 100%;
            overflow: auto;
            padding: 1em 1.5em;
            display: block;
            word-wrap: break-word;
        }
        .dark-mode pre {
            background-color: #2a2a2a;
            border-color: #444;
            color: #f4f4f4;
        }
    </style>
</head>
<body class="dark-mode">
    <button id="modeToggle">Toggle Light/Dark Mode</button>
    <div class="container">
        <h1>YouTube Watch History Playlist Creator</h1>
        
        <h2>Instructions</h2>
        <ol>
            <li>Set up a Google Cloud Project:
                <ul>
                    <li>Go to the <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a>.</li>
                    <li>Create a new project or select an existing one.</li>
                    <li>Enable the YouTube Data API v3 for your project.</li>
                    <li>Create credentials (OAuth client ID) for a Web application.</li>
                    <li>Add "http://localhost:8000" to the Authorized JavaScript origins.</li>
                    <li>Copy your Client ID.</li>
                </ul>
            </li>
            <li>Update this HTML file:
                <ul>
                    <li>Find the line <code>const CLIENT_ID = 'YOUR_CLIENT_ID_HERE';</code></li>
                    <li>Replace 'YOUR_CLIENT_ID_HERE' with your actual Client ID.</li>
                </ul>
            </li>
            <li>Set up a local web server:
                <ul>
                    <li>Open a terminal or command prompt.</li>
                    <li>Navigate to the directory containing this HTML file.</li>
                    <li>Run one of the following commands based on your Python version:
                        <pre>
# For Python 3.x
python -m http.server 8000

# For Python 2.x
python -m SimpleHTTPServer 8000</pre>
                    </li>
                </ul>
            </li>
            <li>Use the application:
                <ul>
                    <li>Open a web browser and go to "http://localhost:8000".</li>
                    <li>Select your Google Takeout zip file.</li>
                    <li>Choose the privacy setting for your playlist.</li>
                    <li>Click "Create Playlist" and follow the authentication prompts.</li>
                </ul>
            </li>
        </ol>

        <h2>Create Your Playlist</h2>
        <input type="file" id="fileInput" accept=".zip">
        <select id="privacySelect">
            <option value="public">Public</option>
            <option value="unlisted" selected>Unlisted</option>
            <option value="private">Private</option>
        </select>
        <button id="createPlaylist">Create Playlist</button>
        <button id="resumeButton" style="display: none;">Resume</button>
        <div id="status"></div>
        <div id="progress"></div>
        <div id="quotaStatus"></div>
        <div id="progressBar">
            <div id="progressBarFill"></div>
        </div>
    </div>

    <script>
        // Your Client ID from the Google Developers Console
        const CLIENT_ID = 'YOUR_CLIENT_ID_HERE';
        
        // Array of API discovery doc URLs for APIs used by the quickstart
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"];

        // Authorization scopes required by the API
        const SCOPES = 'https://www.googleapis.com/auth/youtube.force-ssl';

        // API quota settings
        const DAILY_QUOTA = 10000; // Default daily quota for free tier
        const PLAYLIST_INSERT_COST = 50; // Cost to create a new playlist
        const PLAYLIST_ITEM_INSERT_COST = 50; // Cost to add an item to a playlist

        // Pagination settings
        const BATCH_SIZE = 50; // Number of videos to add in each batch
        const DELAY_BETWEEN_BATCHES = 10000; // Delay between batches in milliseconds (10 seconds)

        let authorizeButton = document.getElementById('createPlaylist');
        let resumeButton = document.getElementById('resumeButton');
        let fileInput = document.getElementById('fileInput');
        let privacySelect = document.getElementById('privacySelect');
        let statusDiv = document.getElementById('status');
        let progressDiv = document.getElementById('progress');
        let quotaStatusDiv = document.getElementById('quotaStatus');
        let progressBarFill = document.getElementById('progressBarFill');
        let modeToggle = document.getElementById('modeToggle');

        let quotaUsed = 0;
        let state = {
            playlistId: null,
            videoIds: [],
            addedVideos: 0,
            totalVideos: 0
        };

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                authorizeButton.onclick = handleAuthClick;
                resumeButton.onclick = handleResumeClick;
                loadState();
            });
        }

        function handleAuthClick() {
            if (fileInput.files.length === 0) {
                statusDiv.textContent = 'Please select a file first.';
                return;
            }

            gapi.auth2.getAuthInstance().signIn().then(function() {
                statusDiv.textContent = 'Processing file...';
                processFile(fileInput.files[0]);
            });
        }

        function handleResumeClick() {
            gapi.auth2.getAuthInstance().signIn().then(function() {
                statusDiv.textContent = 'Resuming...';
                addVideosToPlaylist(state.playlistId, state.videoIds);
            });
        }

        function processFile(file) {
            let zip = new JSZip();
            zip.loadAsync(file).then(function(contents) {
                contents.file("Takeout/YouTube and YouTube Music/history/watch-history.json").async("string").then(function(content) {
                    let watchHistory = JSON.parse(content);
                    createPlaylist(watchHistory);
                });
            });
        }

        function createPlaylist(watchHistory) {
            if (quotaUsed + PLAYLIST_INSERT_COST > DAILY_QUOTA) {
                statusDiv.textContent = 'Daily quota exceeded. Please try again tomorrow.';
                return;
            }

            gapi.client.youtube.playlists.insert({
                part: 'snippet,status',
                resource: {
                    snippet: {
                        title: 'My Watch History',
                        description: 'Playlist created from my watch history'
                    },
                    status: {
                        privacyStatus: privacySelect.value
                    }
                }
            }).then(function(response) {
                quotaUsed += PLAYLIST_INSERT_COST;
                updateQuotaStatus();
                state.playlistId = response.result.id;
                state.videoIds = watchHistory
                    .filter(item => item.titleUrl)
                    .map(item => item.titleUrl.split('v=')[1])
                    .filter((id, index, self) => self.indexOf(id) === index);
                state.totalVideos = state.videoIds.length;
                state.addedVideos = 0;
                saveState();
                addVideosToPlaylist(state.playlistId, state.videoIds);
            });
        }

        function addVideosToPlaylist(playlistId, videoIds) {
            function addBatch(startIndex) {
                let endIndex = Math.min(startIndex + BATCH_SIZE, state.totalVideos);
                let batchIds = videoIds.slice(startIndex, endIndex);

                let availableQuota = DAILY_QUOTA - quotaUsed;
                let batchCost = batchIds.length * PLAYLIST_ITEM_INSERT_COST;

                if (batchCost > availableQuota) {
                    let possibleAdds = Math.floor(availableQuota / PLAYLIST_ITEM_INSERT_COST);
                    batchIds = batchIds.slice(0, possibleAdds);
                    endIndex = startIndex + possibleAdds;
                }

                if (batchIds.length === 0) {
                    statusDiv.textContent = 'Daily quota reached. Progress saved.';
                    saveState();
                    return;
                }

                let promises = batchIds.map(videoId => 
                    gapi.client.youtube.playlistItems.insert({
                        part: 'snippet',
                        resource: {
                            snippet: {
                                playlistId: playlistId,
                                resourceId: {
                                    kind: 'youtube#video',
                                    videoId: videoId
                                }
                            }
                        }
                    })
                );

                Promise.all(promises).then(() => {
                    state.addedVideos += batchIds.length;
                    quotaUsed += batchIds.length * PLAYLIST_ITEM_INSERT_COST;
                    updateProgress(state.addedVideos, state.totalVideos);
                    updateQuotaStatus();
                    saveState();

                    if (endIndex < state.totalVideos && quotaUsed < DAILY_QUOTA) {
                        setTimeout(() => addBatch(endIndex), DELAY_BETWEEN_BATCHES);
                    } else {
                        statusDiv.textContent = state.addedVideos === state.totalVideos ? 
                            'Playlist created successfully!' : 
                            'Daily quota reached. Partial playlist created.';
                        saveState();
                    }
                }).catch(error => {
                    statusDiv.textContent = 'An error occurred: ' + error;
                    saveState();
                });
            }

            addBatch(state.addedVideos);
        }

        function updateProgress(current, total) {
            let percentage = Math.round((current / total) * 100);
            progressDiv.textContent = `Progress: ${current}/${total} videos added`;
            progressBarFill.style.width = percentage + '%';
            progressBarFill.textContent = percentage + '%';
        }

        function updateQuotaStatus() {
            let percentage = Math.round((quotaUsed / DAILY_QUOTA) * 100);
            quotaStatusDiv.textContent = `API Quota: ${quotaUsed}/${DAILY_QUOTA} units used (${percentage}%)`;
        }

        function saveState() {
            localStorage.setItem('youtubePlaylistCreatorState', JSON.stringify(state));
            localStorage.setItem('youtubePlaylistCreatorQuota', quotaUsed.toString());
        }

        function loadState() {
            let savedState = localStorage.getItem('youtubePlaylistCreatorState');
            let savedQuota = localStorage.getItem('youtubePlaylistCreatorQuota');
            
            if (savedState) {
                state = JSON.parse(savedState);
                quotaUsed = parseInt(savedQuota) || 0;
                updateProgress(state.addedVideos, state.totalVideos);
                updateQuotaStatus();
                
                if (state.addedVideos < state.totalVideos) {
                    resumeButton.style.display = 'inline-block';
                }
            }
        }

        modeToggle.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            localStorage.setItem('colorMode', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        });

        // Set initial color mode
        if (localStorage.getItem('colorMode') === 'light') {
            document.body.classList.remove('dark-mode');
            document.body.classList.add('light-mode');
        }

        handleClientLoad();