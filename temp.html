<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Watch History Playlist Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      #fileInput {
        margin-bottom: 10px;
      }
      #createPlaylist {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #createPlaylist:hover {
        background-color: #45a049;
      }
      #status,
      #progress,
      #quotaStatus {
        margin-top: 20px;
        font-weight: bold;
      }
      #progressBar {
        width: 100%;
        background-color: #ddd;
        border-radius: 5px;
        margin-top: 10px;
      }
      #progressBarFill {
        width: 0%;
        height: 30px;
        background-color: #4caf50;
        border-radius: 5px;
        text-align: center;
        line-height: 30px;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>YouTube Watch History Playlist Creator</h1>
      <input type="file" id="fileInput" accept=".zip" />
      <button id="createPlaylist">Create Playlist</button>
      <div id="status"></div>
      <div id="progress"></div>
      <div id="quotaStatus"></div>
      <div id="progressBar">
        <div id="progressBarFill"></div>
      </div>
    </div>

    <script>
      // Your Client ID from the Google Developers Console
      const CLIENT_ID = "YOUR_CLIENT_ID_HERE";

      // Array of API discovery doc URLs for APIs used by the quickstart
      const DISCOVERY_DOCS = [
        "https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest",
      ];

      // Authorization scopes required by the API
      const SCOPES = "https://www.googleapis.com/auth/youtube.force-ssl";

      // API quota settings
      const DAILY_QUOTA = 10000; // Default daily quota for free tier
      const PLAYLIST_INSERT_COST = 50; // Cost to create a new playlist
      const PLAYLIST_ITEM_INSERT_COST = 50; // Cost to add an item to a playlist

      // Pagination settings
      const BATCH_SIZE = 50; // Number of videos to add in each batch
      const DELAY_BETWEEN_BATCHES = 10000; // Delay between batches in milliseconds (10 seconds)

      let authorizeButton = document.getElementById("createPlaylist");
      let fileInput = document.getElementById("fileInput");
      let statusDiv = document.getElementById("status");
      let progressDiv = document.getElementById("progress");
      let quotaStatusDiv = document.getElementById("quotaStatus");
      let progressBarFill = document.getElementById("progressBarFill");

      let quotaUsed = 0;

      function handleClientLoad() {
        gapi.load("client:auth2", initClient);
      }

      function initClient() {
        gapi.client
          .init({
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES,
          })
          .then(function () {
            authorizeButton.onclick = handleAuthClick;
          });
      }

      function handleAuthClick() {
        if (fileInput.files.length === 0) {
          statusDiv.textContent = "Please select a file first.";
          return;
        }

        gapi.auth2
          .getAuthInstance()
          .signIn()
          .then(function () {
            statusDiv.textContent = "Processing file...";
            processFile(fileInput.files[0]);
          });
      }

      function processFile(file) {
        let zip = new JSZip();
        zip.loadAsync(file).then(function (contents) {
          contents
            .file(
              "Takeout/YouTube and YouTube Music/history/watch-history.json"
            )
            .async("string")
            .then(function (content) {
              let watchHistory = JSON.parse(content);
              createPlaylist(watchHistory);
            });
        });
      }

      function createPlaylist(watchHistory) {
        if (quotaUsed + PLAYLIST_INSERT_COST > DAILY_QUOTA) {
          statusDiv.textContent =
            "Daily quota exceeded. Please try again tomorrow.";
          return;
        }

        gapi.client.youtube.playlists
          .insert({
            part: "snippet,status",
            resource: {
              snippet: {
                title: "My Watch History",
                description: "Playlist created from my watch history",
              },
              status: {
                privacyStatus: "unlisted",
              },
            },
          })
          .then(function (response) {
            quotaUsed += PLAYLIST_INSERT_COST;
            updateQuotaStatus();
            let playlistId = response.result.id;
            addVideosToPlaylist(playlistId, watchHistory);
          });
      }

      function addVideosToPlaylist(playlistId, watchHistory) {
        let videoIds = watchHistory
          .filter((item) => item.titleUrl)
          .map((item) => item.titleUrl.split("v=")[1])
          .filter((id, index, self) => self.indexOf(id) === index);

        let totalVideos = videoIds.length;
        let addedVideos = 0;

        function addBatch(startIndex) {
          let endIndex = Math.min(startIndex + BATCH_SIZE, totalVideos);
          let batchIds = videoIds.slice(startIndex, endIndex);

          let availableQuota = DAILY_QUOTA - quotaUsed;
          let batchCost = batchIds.length * PLAYLIST_ITEM_INSERT_COST;

          if (batchCost > availableQuota) {
            let possibleAdds = Math.floor(
              availableQuota / PLAYLIST_ITEM_INSERT_COST
            );
            batchIds = batchIds.slice(0, possibleAdds);
            endIndex = startIndex + possibleAdds;
          }

          if (batchIds.length === 0) {
            statusDiv.textContent = "Daily quota reached. Progress saved.";
            return;
          }

          let promises = batchIds.map((videoId) =>
            gapi.client.youtube.playlistItems.insert({
              part: "snippet",
              resource: {
                snippet: {
                  playlistId: playlistId,
                  resourceId: {
                    kind: "youtube#video",
                    videoId: videoId,
                  },
                },
              },
            })
          );

          Promise.all(promises)
            .then(() => {
              addedVideos += batchIds.length;
              quotaUsed += batchIds.length * PLAYLIST_ITEM_INSERT_COST;
              updateProgress(addedVideos, totalVideos);
              updateQuotaStatus();

              if (endIndex < totalVideos && quotaUsed < DAILY_QUOTA) {
                setTimeout(() => addBatch(endIndex), DELAY_BETWEEN_BATCHES);
              } else {
                statusDiv.textContent =
                  addedVideos === totalVideos
                    ? "Playlist created successfully!"
                    : "Daily quota reached. Partial playlist created.";
              }
            })
            .catch((error) => {
              statusDiv.textContent = "An error occurred: " + error;
            });
        }

        addBatch(0);
      }

      function updateProgress(current, total) {
        let percentage = Math.round((current / total) * 100);
        progressDiv.textContent = `Progress: ${current}/${total} videos added`;
        progressBarFill.style.width = percentage + "%";
        progressBarFill.textContent = percentage + "%";
      }

      function updateQuotaStatus() {
        let percentage = Math.round((quotaUsed / DAILY_QUOTA) * 100);
        quotaStatusDiv.textContent = `API Quota: ${quotaUsed}/${DAILY_QUOTA} units used (${percentage}%)`;
      }

      handleClientLoad();
    </script>
  </body>
</html>
