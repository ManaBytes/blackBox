<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Watch History Playlist Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      #fileInput {
        margin-bottom: 10px;
      }
      #createPlaylist {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #createPlaylist:hover {
        background-color: #45a049;
      }
      #status {
        margin-top: 20px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>YouTube Watch History Playlist Creator</h1>
      <input type="file" id="fileInput" accept=".zip" />
      <button id="createPlaylist">Create Playlist</button>
      <div id="status"></div>
    </div>

    <script>
      // Your Client ID from the Google Developers Console
      const CLIENT_ID = "YOUR_CLIENT_ID_HERE";

      // Array of API discovery doc URLs for APIs used by the quickstart
      const DISCOVERY_DOCS = [
        "https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest",
      ];

      // Authorization scopes required by the API
      const SCOPES = "https://www.googleapis.com/auth/youtube.force-ssl";

      let authorizeButton = document.getElementById("createPlaylist");
      let fileInput = document.getElementById("fileInput");
      let statusDiv = document.getElementById("status");

      function handleClientLoad() {
        gapi.load("client:auth2", initClient);
      }

      function initClient() {
        gapi.client
          .init({
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES,
          })
          .then(function () {
            authorizeButton.onclick = handleAuthClick;
          });
      }

      function handleAuthClick() {
        if (fileInput.files.length === 0) {
          statusDiv.textContent = "Please select a file first.";
          return;
        }

        gapi.auth2
          .getAuthInstance()
          .signIn()
          .then(function () {
            statusDiv.textContent = "Processing file...";
            processFile(fileInput.files[0]);
          });
      }

      function processFile(file) {
        let zip = new JSZip();
        zip.loadAsync(file).then(function (contents) {
          contents
            .file(
              "Takeout/YouTube and YouTube Music/history/watch-history.json"
            )
            .async("string")
            .then(function (content) {
              let watchHistory = JSON.parse(content);
              createPlaylist(watchHistory);
            });
        });
      }

      function createPlaylist(watchHistory) {
        gapi.client.youtube.playlists
          .insert({
            part: "snippet,status",
            resource: {
              snippet: {
                title: "My Watch History",
                description: "Playlist created from my watch history",
              },
              status: {
                privacyStatus: "unlisted",
              },
            },
          })
          .then(function (response) {
            let playlistId = response.result.id;
            addVideosToPlaylist(playlistId, watchHistory);
          });
      }

      function addVideosToPlaylist(playlistId, watchHistory) {
        let videoIds = watchHistory
          .filter((item) => item.titleUrl)
          .map((item) => item.titleUrl.split("v=")[1])
          .filter((id, index, self) => self.indexOf(id) === index);

        let promises = videoIds.map((videoId) =>
          gapi.client.youtube.playlistItems.insert({
            part: "snippet",
            resource: {
              snippet: {
                playlistId: playlistId,
                resourceId: {
                  kind: "youtube#video",
                  videoId: videoId,
                },
              },
            },
          })
        );

        Promise.all(promises)
          .then(() => {
            statusDiv.textContent = "Playlist created successfully!";
          })
          .catch((error) => {
            statusDiv.textContent = "An error occurred: " + error;
          });
      }

      handleClientLoad();
    </script>
  </body>
</html>
